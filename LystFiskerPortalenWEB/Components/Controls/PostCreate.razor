@inject IFileUploadService FileUploadService
@inject IPostRepo PostRepo
@inject NavigationManager NavigationManager
@inject IProfileRepo ProfileRepo
@inject AuthenticationStateProvider _authenticationStateProvider
@inject ITechniqueRepo TechniqueRepo
@inject ILureRepo LureRepo
@rendermode InteractiveServer

<h3>Opret en ny post</h3>

<div class="card" style="width: 32rem; margin-bottom: 2%">
	<EditForm Model="post" FormName="CreateForm" OnValidSubmit="CreatePost">
		<DataAnnotationsValidator></DataAnnotationsValidator>
		<ValidationSummary></ValidationSummary>

		<div class="card-body">
			<div>
				<div class="row mb-3">
					<div class="col-2">
						<label for="title" class="form-label">Titel</label>
					</div>
					<div class="col-10">
						<InputText class="card-title" @bind-Value="post.Title"></InputText>
					</div>
				</div>

				<div class="row mb-3">
					<div class="col-2">
						<label for="description" class="form-label">Beskrivelse</label>
					</div>
					<div class="col-10">
						<InputTextArea @bind-Value="post.Description"></InputTextArea>
					</div>
					<div class="col">
						<ValidationMessage For="@(() => post.Description)"></ValidationMessage>
					</div>
				</div>

				<div class="row mb-3">
					<div class="col-2">
						<label for="location" class="form-label">Lokation</label>
					</div>
					<div class="col-10">
						<InputText @bind-Value="post.Location"></InputText>
					</div>
				</div>

				<div class="row mb-3">
					<div class="col-2">
						<label for="picture" class="form-label">Billeder</label>
					</div>
					<div class="col-10">
						<InputFile OnChange="OnFilesSelected" class="form-control" multiple accept="image/*" />
						<small class="text-muted">Du kan vælge flere billeder ad gangen.</small>

						@if (post.Images?.Any() == true)
						{
							<div class="d-flex flex-wrap gap-2 mt-2">
								@foreach (var image in post.Images)
								{
									<div class="position-relative">
										<img src="@image.ImageUrl" class="rounded shadow-sm" style="width: 90px; height: 90px; object-fit: cover;" />
										<button type="button"
												class="btn btn-sm btn-light border position-absolute top-0 end-0"
												title="Fjern billede"
												@onclick="() => RemoveImage(image)">
											&times;
										</button>
									</div>
								}
							</div>
						}
					</div>
				</div>

				<div class="mb-3">
					<label class="form-label">Teknik</label>
					<InputSelect class="form-select" @bind-Value="post.TechniqueId">
						<option value="none" selected hidden disabled>Vælg Teknik</option>
						@foreach (var tech in techniques)
						{
							<option value="@tech.Id">@tech.Name</option>
						}
					</InputSelect>
				</div>

				<div class="mb-3">
					<label class="form-label">Blink</label>
					<InputSelect class="form-select" @bind-Value="post.LureId">
						<option value="none" selected disabled hidden>Vælg Blink</option>
						@foreach (var lure in lures)
						{
							<option value="@lure.Id">@lure.Name</option>
						}
					</InputSelect>
				</div>

				<button class="btn btn-primary" style="float: right;" type="submit">Opret</button>
			</div>
		</div>
	</EditForm>
</div>

@code {
	[SupplyParameterFromForm(FormName = "CreateForm")]
	public Post post { get; set; } = new Post();


	[Inject]
	private IPostRepo postRepo { get; set; }

	private bool forceReloadPage = true;

	private async Task CreatePost()
	{

		post.CreationDate = DateTime.Now;
		if (post.TechniqueId is null)
			post.TechniqueId = 1;

		if (post.LureId is null)
			post.LureId = 1;

		post.Likes = 0;
		await postRepo.CreatePost(post);
		NavigationManager.NavigateTo("/", forceReloadPage);
	}

	private async Task OnFilesSelected(InputFileChangeEventArgs e)
	{
		foreach (var file in e.GetMultipleFiles())
		{
			var url = await fileUploadService.UploadFile(file, "PostImages");

			if (string.IsNullOrWhiteSpace(url))
			{
				continue;
			}

			if (post.Images.Any(img => img.ImageUrl.Equals(url, StringComparison.OrdinalIgnoreCase)))
			{
				continue;
			}

			post.Images.Add(new PostImage { ImageUrl = url });
		}
	}

	private void RemoveImage(PostImage image)
	{
		if (post.Images.Contains(image))
		{
			post.Images.Remove(image);
		}
	}

	[Inject]
	private IFileUploadService fileUploadService { get; set; }

	private List<Technique> techniques { get; set; } = new List<Technique>();

	private List<Lure> lures { get; set; } = new List<Lure>();



	protected override async Task OnInitializedAsync()
	{
		var authState = await _authenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		post.ProfileID = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
		lures = await LureRepo.GetAllLures();
		techniques = await TechniqueRepo.GetAllTechs();

		post.Profile = await ProfileRepo.GetProfileById(post.ProfileID);
	}
}