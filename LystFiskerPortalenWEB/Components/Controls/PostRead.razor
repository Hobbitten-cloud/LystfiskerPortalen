@inject IPostRepo PostRepo

@inject ITechniqueRepo TechniqueRepo
@inject ILureRepo LureRepo

@inject ICommentRepo CommentRepo
@inject NavigationManager NavigationManager

@inject AuthenticationStateProvider AuthenticationStateProvider

@if (Posts == null)
{
	<p>Loading posts....</p>
}
else if (Posts.Count == 0)
{
	<p>Der er ingen posts at vise.</p>
}
else
{
	@foreach (var post in Posts)
	{
		<div class="card mb-4 shadow-sm" style="max-width: 36rem;">
			@if (!post.IsEditing)
			{
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<span>
							<img src="@post.Profile?.ImagePath" class="rounded-circle me-2" alt="Profilbillede ikke fundet" style="width: 40px; height: 40px; object-fit: cover;">
							@post.Profile?.UserName
						</span>
						<p>@post.CreationDate.ToString("dd-MM-yyyy HH:mm")</p>
					</div>

					<h5 class="card-title mt-2">@post.Title</h5>
					<p class="card-text mb-1">@post.Description</p>
					<p class="card-text mb-2">@post.Location</p>

					@{
						var carouselId = $"post-carousel-{post.Id}";
					}
					@if (post.Images?.Any() == true)
					{
						<div id="@carouselId" class="carousel slide mb-3" data-bs-ride="carousel">
							<div class="carousel-inner">
								@for (var i = 0; i < post.Images.Count; i++)
								{
									var image = post.Images[i];
									<div class="carousel-item @(i == 0 ? "active" : string.Empty)">
										<img src="@image.ImageUrl" class="d-block w-100 rounded" alt="Billede ikke fundet" style="object-fit: cover; max-height: 22rem;" />
									</div>
								}
							</div>
							@if (post.Images.Count > 1)
							{
								<button class="carousel-control-prev" type="button" data-bs-target="#@carouselId" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Forrige</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#@carouselId" data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Næste</span>
								</button>
							}
						</div>
					}
					else
					{
						<div class="bg-light text-center rounded mb-3 py-5">
							<span class="text-muted">Ingen billeder tilføjet endnu.</span>
						</div>
					}

					<div class="d-flex justify-content-between align-items-center mt-2">
						<div>
							@if (post.Technique != null)
							{
								<p class="badge bg-primary me-2">@post.Technique.Name</p>
							}
							else
							{
								<p class="badge bg-primary me-2">Ukendt Teknik</p>
							}
							@if (post.Lure != null)
							{
								<p class="badge bg-info text-dark">@post.Lure.Name</p>
							}
							else
							{
								<p class="badge bg-info text-dark">Ukendt Blink</p>
							}
						</div>
						<div>
							<p>Likes @post.Likes</p>
							<button class="btn-primary" @onclick="@(() => LikePost(post))">Like Post</button>
						</div>
						<button class="btn btn-outline-warning btn-sm" @onclick="@(() => StartEdit(post))">Ændr</button>
						<button class="btn btn-outline-danger btn-sm ms-2" @onclick="@(() => DeletePost(post.Id))">Slet</button>
					</div>
				</div>
			}
			else
			{
				<div class="card-body">
					<div class="d-flex justify-content-between">
						<p>Rediger post</p>
						<p>@post.CreationDate.ToString("dd-MM-yyyy HH:mm")</p>
					</div>

					<div class="mb-3 mt-2">
						<label class="form-label">Titel</label>
						<InputText class="form-control" @bind-Value="post.Title" />
					</div>

					<div class="mb-3">
						<label class="form-label">Beskrivelse</label>
						<InputTextArea class="form-control" @bind-Value="post.Description" rows="3" />
					</div>

					<div class="mb-3">
						<label class="form-label">Teknik</label>
						<InputSelect class="form-select" @bind-Value="post.TechniqueId">
							@foreach (var tech in techniques)
							{
								<option value="@tech.Id">@tech.Name</option>
							}
						</InputSelect>
					</div>

					<div class="mb-3">
						<label class="form-label">Blink</label>
						<InputSelect class="form-select" @bind-Value="post.LureId">
							@foreach (var lure in lures)
							{
								<option value="@lure.Id">@lure.Name</option>
							}
						</InputSelect>
					</div>

					<div class="mb-3">
						<label class="form-label">Lokation</label>
						<InputText class="form-control" @bind-Value="post.Location" />
					</div>

					<div class="mb-3">
						<label class="form-label">Billeder</label>
						@if (post.Images?.Any() == true)
						{
							<div class="d-flex flex-wrap gap-2">
								@foreach (var image in post.Images)
								{
									<img src="@image.ImageUrl" class="rounded border" style="width: 80px; height: 80px; object-fit: cover;" />
								}
							</div>
							<small class="text-muted d-block mt-2">Billeder kan i øjeblikket kun tilføjes ved oprettelse af en ny post.</small>
						}
						else
						{
							<p class="text-muted mb-0">Ingen billeder tilføjet endnu.</p>
						}
					</div>

					<div class="d-flex justify-content-end">
						<button class="btn btn-success btn-sm me-2" @onclick="@(() => SavePost(post))">Gem</button>
						<button class="btn btn-outline-secondary btn-sm" @onclick="@(() => CancelEdit(post))">Annuller</button>
					</div>
				</div>
			}

			<hr />

			<div class="card-footer bg-white border-0">
				@if (post.Comments?.Any() == true)
				{
					<ul class="list-group list-group-flush mb-3">
						@foreach (var comment in post.Comments)
						{
							<li class="list-group-item px-0">
								<div class="d-flex justify-content-between">
									<span>@comment.Description</span>
									<small class="text-muted">@comment.CreationDate.ToString("dd-MM-yyyy HH:mm")</small>
								</div>
							</li>
						}
					</ul>
				}
				else
				{
					<p class="text-muted mb-3">Ingen kommentarer endnu.</p>
				}

				@{
					var commentModel = GetCommentModel(post.Id);
				}
				<EditForm Model="@commentModel" FormName="CreateCommentForm" OnValidSubmit="@(() => CreateComment(post))">
					<DataAnnotationsValidator></DataAnnotationsValidator>
					<ValidationSummary></ValidationSummary>
					<div class="input-group">
						<InputText class="form-control" @bind-Value="commentModel.Description" placeholder="Skriv en kommentar..." />
						<button class="btn btn-primary" type="submit">Send</button>
					</div>
				</EditForm>
			</div>
		</div>
	}
}

@code {
	[Parameter]
	public List<Post> Posts { get; set; }
	private readonly Dictionary<int, Comment> commentModels = new();

	[Parameter]
	public string? UserId { get; set; }
	[Parameter]
	public bool IsProfilePage { get; set; }

	private List<Technique> techniques { get; set; } = new();
	private List<Lure> lures { get; set; } = new();

	protected override async Task OnInitializedAsync()
	{
		techniques = await TechniqueRepo.GetAllTechs() ?? new();
		lures = await LureRepo.GetAllLures() ?? new();
	}

	// Method for liking a post
	private async Task LikePost(Post post)
	{
		await PostRepo.LikePost(post);

		//posts = await PostRepo.GetAllPosts();
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		UserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? null;
		if (UserId is not null && IsProfilePage)
		{
			// Filter posts only for the given user
			Posts = await PostRepo.GetPostsByUser(UserId);
		}
		else
		{
			// Load all posts
			Posts = await PostRepo.GetAllPosts();
		}
	}

	// Methods for editing posts
	private void StartEdit(Post post)
	{
		post.IsEditing = true;
	}

	private async Task CancelEdit(Post post)
	{
		post.IsEditing = false;
	}

	private async Task SavePost(Post post)
	{
		await PostRepo.UpdatePost(post);
		post.Technique = techniques.FirstOrDefault(t => t.Id == post.TechniqueId);//gemmer ændre på tech
		post.Lure = lures.FirstOrDefault(l => l.Id == post.LureId);//gemmer ændre på lure
		post.IsEditing = false;
		StateHasChanged();
	}

	private async Task DeletePost(int id)
	{
		await PostRepo.DeletePost(id);
		Posts = await PostRepo.GetAllPosts();
	}

	// Methods related to commenting
	private Comment GetCommentModel(int postId)
	{
		if (!commentModels.TryGetValue(postId, out var comment))
		{
			comment = new Comment();
			commentModels[postId] = comment;
		}

		return comment;
	}

	private async Task CreateComment(Post post)
	{
		var commentModel = GetCommentModel(post.Id);
		if (string.IsNullOrWhiteSpace(commentModel.Description))
		{
			return;
		}

		var newComment = new Comment
			{
				Description = commentModel.Description,
				PostId = post.Id,
				CreationDate = DateTime.Now
			};

		await CommentRepo.CreateComment(newComment);
		await RefreshPost(post.Id);

		commentModels[post.Id] = new Comment();
	}

	private async Task RefreshPost(int postId)
	{
		if (Posts == null)
		{
			return;
		}

		var updatedPost = await PostRepo.GetPostWithComments(postId);
		if (updatedPost == null)
		{
			return;
		}

		var index = Posts.FindIndex(p => p.Id == postId);
		if (index >= 0)
		{
			updatedPost.IsEditing = Posts[index].IsEditing;
			Posts[index] = updatedPost;
		}
	}
}
